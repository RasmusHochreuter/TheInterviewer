# Feature: Order Cancellation
> Specification generated by /interview on 2026-02-13
> ‚ö†Ô∏è This is a planning document. No implementation code has been written.

## Implementation Instructions
This specification is context for the implementing agent. Read and internalize it fully before writing any code.

**IMPORTANT ‚Äî Do NOT:**
- Add comments referencing this spec (no `// See spec: ...`, no `// REQ-001`, no `// Don't #3`)
- Structure code around spec sections ‚Äî structure it around clean domain logic
- Embed spec traceability IDs in code, comments, variable names, or test names
- Add comments explaining "why" when the code is self-documenting

**DO:**
- Write clean, idiomatic C# that follows the reference implementation patterns
- Let the constraints from this spec guide your decisions silently ‚Äî they should be invisible in the final code
- Name things after domain concepts, not spec concepts
- Write tests that verify behavior, named after what they verify (not after spec requirement IDs)

## Overview
Allow customers to cancel orders through the API, with behavior varying based on order status, customer tier, and amount thresholds. Refunds are processed via the payment mediator and cancellation events are published for downstream consumers.

## Scope
### In Scope
- Single-order cancellation via REST API
- Refund calculation based on order status, customer tier, and amount thresholds
- Manager review queue for high-value refunds (>$500)
- VIP-specific business rules (extended windows, priority queue)
- Audit trail of cancellation decisions
- Domain event publishing for async notifications

### Out of Scope
- Bulk/batch cancellation (cancel multiple orders at once)
- Admin-initiated cancellations on behalf of customers
- Partial cancellation (cancel individual line items within an order)
- Self-service return shipping label generation

### Deferred
- Store credit bonus amounts for VIP goodwill (needs product decision)
- Cancellation analytics dashboard
- Automated fraud pattern detection on cancellation behavior

## Reference Implementation
- Reference: `src/Features/Orders/PlaceOrder/PlaceOrderHandler.cs`
- Follow the same: MediatR command/handler split, FluentValidation validator, repository usage, domain event publishing, test structure with NSubstitute mocks
- Also reference: `src/Features/Orders/PlaceOrder/PlaceOrderValidator.cs` for validation pattern

## Codebase Context
- Architecture: Vertical Slices within Clean Architecture (features grouped by use case, domain layer is dependency-free)
- ORM: EF Core 8 with repository pattern (`IOrderRepository`, `ICustomerRepository`)
- Mediator: MediatR ‚Äî all use cases are Command/Query handlers
- Test framework: xUnit + NSubstitute + FluentAssertions
- Validation: FluentValidation ‚Äî validators auto-registered via `AddValidatorsFromAssembly()`
- DI registration: Via `AddOrderModule()` extension in `src/Features/Orders/OrderModule.cs`
- Error handling: `Result<T>` pattern with `Error` value object ‚Äî never throws for business rule violations, only for infrastructure failures
- API pattern: Minimal APIs with `TypedResults` ‚Äî each feature has an `Endpoint.cs` that maps routes

## Requirements
- Customers can request cancellation of any order they own
- Cancellation triggers the appropriate refund based on order status and amount
- VIP customers receive priority handling and extended return windows
- All cancellation attempts are audit-logged with the decision path taken
- Cancellation confirmation is sent asynchronously via domain event (not inline)

## Prohibitions (Don'ts)
- ‚ùå NEVER auto-approve a cancellation where the refund exceeds $500 ‚Äî queue for manager review. This is a compliance requirement.
- ‚ùå NEVER call the payment gateway directly ‚Äî all refunds go through `IPaymentMediator`. Direct gateway calls bypass idempotency and audit logging.
- ‚ùå NEVER return raw exception details to the API caller ‚Äî use the `Result<T>` pattern for business errors and `ProblemDetails` for infrastructure errors.
- ‚ùå NEVER process a refund without an `IdempotencyKey` ‚Äî duplicate refunds have caused real financial loss in the past.
- ‚ùå NEVER send emails or HTTP calls inside a DB transaction ‚Äî publish a `CancellationCompletedEvent` and let the event handler send notifications.
- ‚ùå NEVER trust the client-supplied order amount for refund calculation ‚Äî always re-fetch from `IOrderRepository`.
- ‚ùå NEVER log full credit card numbers, customer email addresses, or auth tokens in cancellation logs ‚Äî log only masked card suffix and customer ID.
- ‚ùå NEVER use the legacy `OrderService` class ‚Äî it's deprecated and scheduled for removal. Use the MediatR handler pattern instead.

## Decision Tree
```
Order Cancellation Request
‚îÇ
‚îú‚îÄ‚îÄ Validation
‚îÇ   ‚îú‚îÄ‚îÄ Order not found ‚Üí 404 NotFound
‚îÇ   ‚îú‚îÄ‚îÄ Customer doesn't own order ‚Üí 403 Forbidden
‚îÇ   ‚îú‚îÄ‚îÄ Order already cancelled ‚Üí 409 Conflict
‚îÇ   ‚îî‚îÄ‚îÄ Validation passes ‚Üí Continue
‚îÇ
‚îú‚îÄ‚îÄ Customer is VIP?
‚îÇ   ‚îî‚îÄ‚îÄ YES ‚Üí Flag for priority handling (never auto-decline VIP)
‚îÇ
‚îú‚îÄ‚îÄ Order Status?
‚îÇ   ‚îú‚îÄ‚îÄ Processing (not shipped)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Full refund ‚Üí Cancel immediately
‚îÇ   ‚îú‚îÄ‚îÄ Shipped (not delivered)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Initiate return ‚Üí Partial refund (minus shipping cost)
‚îÇ   ‚îú‚îÄ‚îÄ Delivered ‚â§ 30 days (90 for VIP)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Require return request first ‚Üí Queue, don't process yet
‚îÇ   ‚îî‚îÄ‚îÄ Delivered > 30 days (90 for VIP)
‚îÇ       ‚îî‚îÄ‚îÄ Decline refund ‚Üí Offer store credit as goodwill
‚îÇ
‚îú‚îÄ‚îÄ Calculated refund > $500?
‚îÇ   ‚îî‚îÄ‚îÄ YES ‚Üí Queue for manager review (never auto-approve)
‚îÇ
‚îî‚îÄ‚îÄ Payment gateway available?
    ‚îú‚îÄ‚îÄ YES ‚Üí Process refund via IPaymentMediator
    ‚îî‚îÄ‚îÄ NO ‚Üí Queue with retry policy ‚Üí Alert ops after 3 failures
```

## Domain Rules & Exceptions
| Rule | Applies When | Exception | Who Can Override |
|------|-------------|-----------|-----------------|
| SLA: process within 24h | Enterprise tier | Paused during maintenance windows (check `IMaintenanceSchedule`) | Account managers can escalate to 4h |
| SLA: process within 48h | Standard tier | Same maintenance pause | Same |
| No refund after 30 days | Standard + Enterprise | VIP customers: extended to 90 days | No manual override |
| Shipping cost non-refundable | Order status = Shipped | Waived if cancellation caused by fulfillment error (`Order.HasFulfillmentError`) | Support team via `ForceFullRefund` flag |
| Store credit expires in 1 year | All goodwill credits | None | None |
| Max 3 cancellations per customer per month | All tiers | VIP exempt | None [NEEDS CLARIFICATION: Should there be any limit for VIP, even if higher? e.g., 10/month?] |

## Escalation & Guardrails
- üõë **Fail if**: Order not found, customer doesn't own order, idempotency conflict detected, refund amount doesn't match recalculated total (possible tampering)
- ‚è∏Ô∏è **Queue for review if**: Refund amount > $500, customer flagged for fraud review, VIP customer (priority queue), return window is borderline (within 48h of expiry)
- üîÑ **Retry with backoff if**: Payment gateway returns 503 ‚Äî max 3 attempts with exponential backoff (2s, 4s, 8s), then queue for manual processing
- üîî **Alert if**: Gateway failure rate exceeds 10% in 5-minute window (circuit breaker via Polly), any refund amount calculation mismatch detected

## Data Model
- New entity: `CancellationRequest` ‚Äî belongs to `Order`, references `Customer`
  - Properties: `Id`, `OrderId`, `CustomerId`, `Reason`, `RequestedAt`, `Status` (enum: Pending, Approved, Declined, PendingReview), `RefundAmount`, `RefundMethod`, `IdempotencyKey`, `DecisionPath` (string ‚Äî records which branch was taken), `ReviewedBy` [NEEDS CLARIFICATION: Is this a UserId, or a role/team name? Depends on how manager review queue is implemented], `ReviewedAt`
- New enum: `CancellationStatus` in `src/Features/Orders/Domain/`
- Modified: `Order` entity ‚Äî add `CancellationRequestId` (nullable FK)
- Migration needed: Yes ‚Äî new `CancellationRequests` table + nullable FK column on `Orders`

## API Contract
- Route: `POST /api/orders/{orderId}/cancel`
- Auth: Bearer token, must own the order (check via `ICurrentUserService.UserId`)
- Request body fields:
  - `reason` (string, required, max 500 chars) ‚Äî customer's stated reason for cancellation
  - `refundPreference` (string, required, one of: `original-payment-method`, `store-credit`) ‚Äî where the refund should go
- Success responses:
  - `200 OK` (immediate approval) ‚Äî returns cancellationId (guid), status ("approved"), refundAmount (decimal), refundMethod (string)
  - `202 Accepted` (queued for review) ‚Äî returns cancellationId (guid), status ("pending-review"), estimatedReviewTime (string, e.g. "24h")
- Error responses:
  - `403 Forbidden` ‚Äî customer doesn't own this order
  - `404 NotFound` ‚Äî order doesn't exist
  - `409 Conflict` ‚Äî order already cancelled
  - `422 UnprocessableEntity` ‚Äî validation failure (missing reason, invalid preference)

## Acceptance Criteria

### Happy Path
- [ ] Given a Processing order under $500, when the owning customer requests cancellation, then a full refund is approved immediately and a `CancellationCompletedEvent` is published
- [ ] Given a Shipped order, when cancelled, then a partial refund (minus shipping) is calculated and processed
- [ ] Given a VIP customer with a 60-day-old delivered order, when cancelled, then it is accepted (within 90-day VIP window)

### Negative / Prohibition Tests
- [ ] Given a refund amount of $750, when auto-approve is attempted, then it MUST return status `pending-review` ‚Äî never `approved`
- [ ] Given a cancellation request, then the payment gateway is NEVER called directly ‚Äî only `IPaymentMediator.SubmitRefundAsync()` is invoked
- [ ] Given any cancellation, then the logs NEVER contain customer email, full card number, or auth tokens
- [ ] Given a cancellation, then no email is sent synchronously ‚Äî only a domain event is published

### Edge Cases
- [ ] Given two simultaneous cancellation requests for the same order, then only one succeeds and the other returns `409 Conflict` (idempotency)
- [ ] Given a Standard customer at exactly 30 days since delivery, then the cancellation is still accepted (boundary inclusive)
- [ ] Given a Standard customer at 31 days since delivery, then refund is declined but store credit is offered
- [ ] Given a customer with 3 cancellations already this month (non-VIP), then the request is declined with a clear message

### Integration / Resilience
- [ ] Given the payment gateway returns 503, then the refund is queued with exponential backoff (verified via mock)
- [ ] Given the payment gateway fails 3 times, then the cancellation is parked for manual processing and ops is alerted
- [ ] Given `IMaintenanceSchedule` reports an active window, then the SLA clock is paused (verified in `SlaCalculator` unit test)

## Files to Create / Modify (Implementation Plan)
Based on the reference implementation pattern in `src/Features/Orders/PlaceOrder/`:
- Create: `src/Features/Orders/CancelOrder/CancelOrderCommand.cs` ‚Äî command record with OrderId, Reason, RefundPreference, IdempotencyKey
- Create: `src/Features/Orders/CancelOrder/CancelOrderHandler.cs` ‚Äî main handler with decision tree logic; follow the pattern in `PlaceOrderHandler.cs`
- Create: `src/Features/Orders/CancelOrder/CancelOrderValidator.cs` ‚Äî FluentValidation rules; follow the pattern in `PlaceOrderValidator.cs`
- Create: `src/Features/Orders/CancelOrder/CancelOrderEndpoint.cs` ‚Äî minimal API endpoint mapping; follow the pattern in `PlaceOrderEndpoint.cs`
- Create: `src/Features/Orders/Domain/CancellationRequest.cs` ‚Äî new entity with properties listed in Data Model
- Create: `src/Features/Orders/Domain/CancellationStatus.cs` ‚Äî enum: Pending, Approved, Declined, PendingReview
- Create: `src/Features/Orders/Events/CancellationCompletedEvent.cs` ‚Äî domain event for async notification and audit
- Create: `tests/Features/Orders/CancelOrder/CancelOrderHandlerTests.cs` ‚Äî unit tests covering all acceptance criteria; follow test naming in `PlaceOrderHandlerTests.cs`
- Create: `tests/Features/Orders/CancelOrder/CancelOrderValidatorTests.cs` ‚Äî validation edge cases
- Modify: `src/Features/Orders/Domain/Order.cs` ‚Äî add nullable `CancellationRequestId` FK property
- Modify: `src/Features/Orders/OrderModule.cs` ‚Äî register handler, validator, and event handler in DI
- Modify: `src/Infrastructure/Persistence/AppDbContext.cs` ‚Äî add `DbSet<CancellationRequest>`, configure relationship in `OnModelCreating`
- Create: EF Core migration for new `CancellationRequests` table + nullable FK column on `Orders`

## Observability
- Log (Info): Cancellation requested (orderId, customerId, decision path taken)
- Log (Info): Refund processed successfully (cancellationId, amount, method)
- Log (Warning): Cancellation queued for review (cancellationId, reason: amount threshold / VIP / fraud flag)
- Log (Warning): Payment gateway retry (attempt number, cancellationId)
- Log (Error): Payment gateway circuit breaker opened (failure rate, window)
- Log (Error): Refund amount mismatch detected (expected vs calculated ‚Äî possible tampering)
- Metrics: `order_cancellations_total` (counter, labels: status, tier), `refund_processing_duration_seconds` (histogram), `payment_gateway_failures_total` (counter)
- Never log: Customer email, full card number, auth tokens, IP address

## Key Decisions Made
| Decision | Options Considered | Chosen | Rationale |
|----------|-------------------|--------|-----------|
| Error handling pattern | A) Result\<T\> (like PlaceOrder) B) ValidationException (like ImportData) C) Inline | A) Result\<T\> | 80% of existing handlers use this pattern; keeps it consistent |
| Entry point | A) API endpoint B) Background job C) Event handler D) Multiple | A) API endpoint | Customer-initiated action, needs synchronous feedback |
| Auto-approval threshold | A) $500 cap B) Risk-score based C) No threshold D) Per-tier | A) $500 cap | Compliance requirement from finance; simplest to audit |
| Refund processing | A) Synchronous via mediator B) Queue for async C) Direct gateway call | A) Synchronous via mediator | Matches existing payment patterns; idempotency built into mediator |
| Failure strategy (gateway) | A) Fail fast B) Retry + fail C) Queue for later D) Degrade | B) Retry 3x then queue | Gateway has transient 503s ~2% of the time; queuing prevents data loss |
| Observability level | A) Minimal B) Moderate C) High D) Regulated audit | C) High | Financial operation; need full decision path for dispute resolution |

## Open Questions
_Broader strategic questions needing input from other teams. Tactical gaps are marked inline as `[NEEDS CLARIFICATION]` where they occur._
- What's the retention policy for `CancellationRequest` records? Need input from compliance.
- Should the store credit amount match the refund amount exactly, or can there be a goodwill bonus for VIP? Need product decision.
- Do we need GDPR right-to-erasure support for cancellation records? Need legal input.
